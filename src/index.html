<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCA Home</title>

  <!--Styles -->
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/mockOCA.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <script src="../common/firebase-config.js"></script>
  <script src="../common/auth.js"></script>
  

  <!--NavBar-->
  <script defer src="../common/navbar.js"></script>
</head>

<body>

  <!--Mode Selector-->
  <div class="mode-switch">
    <button id="modeButton">Tutoring Mode</button>
  </div>

  <!--Chatroom Selector-->
  <section class="chatroom">
    <div class="chat-history" id="chatHistory"></div>

    <div class="chat-input">
      <input 
      type="text" 
      id="userInput" 
      placeholder="Type your message..." 
      autocomplete="off"
      />
      <button id="sendMessage">Send</button>
    </div>
  </section>

  <script>
    
    // This is incase of future implementation which will allow user to actually sign up, as of right now, the login button simply directs the user to the index.html since we are viewing in Live Server (it's not actually published):
    // requireAuth();

    // ---- Cached DOM Element ----
    const modeButton = document.getElementById("modeButton");
    modeButton.addEventListener("click", function () {
      if (modeButton.textContent === "Tutoring Mode") {
        modeButton.textContent = "Conceptual Mode";
      } else {
        modeButton.textContent = "Tutoring Mode";
      }
    });

    function sendMessage() {
      const userInput = document.getElementById("userInput").value;
      const chatHistory = document.getElementById("chatHistory");

      if (userInput.trim() !== "") {
        const userMessage = document.createElement("p");
        userMessage.textContent = userInput;
        userMessage.classList.add("user-msg");
        chatHistory.appendChild(userMessage);

        chatHistory.scrollTop = chatHistory.scrollHeight;

         document.getElementById("userInput").value = "";

        const currentMode = modeButton.textContent.includes("Tutoring")
          ? "Tutoring"
          : "Conceptual";

        fetch("http://127.0.0.1:8000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: userInput,
            mode: currentMode
          })
        })
        .then(response => response.json())
        .then(data => {
          const ocaMessage = document.createElement("p");
          ocaMessage.textContent = "OCA: " + data.reply;
          ocaMessage.classList.add("oca-msg");
          chatHistory.appendChild(ocaMessage);

          chatHistory.scrollTop = chatHistory.scrollHeight;
        })
        .catch(error => {
          console.error("Error:", error);
          const errorMsg = document.createElement("p");
          errorMsg.textContent = "OCA: Sorry, something went wrong.";
          errorMsg.classList.add("oca-msg");
          chatHistory.appendChild(errorMsg);

          chatHistory.scrollTop = chatHistory.scrollHeight;
        });
      }
    }

    document.getElementById("sendMessage").addEventListener("click", sendMessage);

    document.getElementById("userInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
  </script>

</body>
</html>
